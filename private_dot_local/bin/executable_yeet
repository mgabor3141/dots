#!/usr/bin/env bash
# yeet - push the current change to a remote branch.
trap 'echo "Error on line $LINENO: $BASH_COMMAND" >&2' ERR
set -Eeuo pipefail
#
# Default: find the nearest ancestor bookmark between trunk and the target
#          commit, move it to the target, and push. Falls back to creating a
#          new bookmark if none exists.
# --new/-n: always create a new bookmark and branch (for stacked PRs).
# --noai:   skip AI-generated PR title/description.

# Parse flags.
new_flag=false
noai_flag=false
args=""
for arg in "$@"; do
    case "$arg" in
        -n|--new) new_flag=true ;;
        --noai) noai_flag=true ;;
        *) args="$args $arg" ;;
    esac
done

open_url() {
    if command -v open >/dev/null 2>&1; then
        open "$1"
    elif command -v xdg-open >/dev/null 2>&1; then
        xdg-open "$1"
    fi
}

# If @ has changes but no description, generate one with AI and commit.
has_changes=$(jj log -r '@ ~ empty()' --count --no-pager 2>/dev/null)
current_desc=$(jj log -r '@' --no-graph -T 'description' --no-pager 2>/dev/null | sed '/^$/d')
if [ "$has_changes" -gt 0 ] && [ -z "$current_desc" ]; then
    echo "Working change has no description — generating one..."
    commit_diff=$(jj diff -r '@' --no-pager 2>/dev/null)

    # Grab recent commit descriptions from trunk as style examples.
    example_commits=$(jj log -r 'trunk()- | trunk()-' --no-graph --limit 10 \
        -T 'description.first_line() ++ "\n"' --no-pager 2>/dev/null \
        | sed '/^$/d' | head -10)
    examples_section=""
    if [ -n "$example_commits" ]; then
        examples_section="
Here are recent commit messages from this repo — match their style and conventions:
$example_commits
"
    fi

    commit_prompt="You are writing a jj/git commit description.

Below is the diff for the current change:
$commit_diff
${examples_section}
Write a concise commit description. First line is a short summary (imperative mood, no period).
If needed, add a blank line then a brief body. No filler.
Match the style of the example commits if provided."

    if commit_msg=$(pi -p --no-session --no-tools "$commit_prompt" 2>/dev/null); then
        echo ""
        printf '%s\n' "$commit_msg"
        echo ""
        jj commit -m "$commit_msg"
    else
        echo "AI description generation failed — commit with an empty description or describe manually."
        exit 1
    fi
fi

# Fetch and rebase before pushing.
jj git fetch
reheat

# Abort if there are conflicts after rebasing.
if [ "$(jj log -r 'trunk()..@ & conflicts()' --count --no-pager)" -gt 0 ]; then
    echo "conflicts detected after rebase — resolve them before pushing"
    exit 1
fi

# Target: current commit if not empty, parent if empty.
target='(@ ~ empty()) | parents(@ & empty())'

# Decide mode: if --new, or no ancestor bookmark exists, create new.
bookmark=""
if [ "$new_flag" = false ]; then
    bookmark=$(jj log -r "trunk()..($target) & bookmarks()" --no-graph \
        -T 'local_bookmarks.map(|b| b.name()).join("\n")' \
        --limit 1 2>/dev/null | head -1)
fi

if [ -n "$bookmark" ]; then
    # Move existing bookmark to target and push.
    jj bookmark move "$bookmark" --to "$target" 2>&1
    output=$(jj git push --bookmark "$bookmark" $args 2>&1)
    rc=$?
else
    # Create a new bookmark via the push-new alias.
    output=$(jj push-new $args 2>&1)
    rc=$?
fi

printf '%s\n' "$output"

# Auto-open "create PR" links (contain /pull/new/ or /compare/).
url=$(printf '%s\n' "$output" | grep -oE 'https?://[^ ]+' | head -1 || true)
if [ -n "$url" ]; then
    case "$url" in
        */pull/new/*|*/compare/*)
            # Determine the pushed branch name.
            if [ -n "$bookmark" ]; then
                branch="$bookmark"
            else
                branch=$(printf '%s\n' "$output" \
                    | sed -n 's/.*Creating bookmark \([^ ]*\).*/\1/p' | head -1)
            fi

            # Generate PR title + description with AI, create a draft PR.
            if [ "$noai_flag" = false ] && command -v pi >/dev/null 2>&1 \
                    && command -v gh >/dev/null 2>&1 && [ -n "$branch" ]; then
                descriptions=$(jj log -r "trunk()..($target)" --no-graph \
                    -T 'description ++ "\n---\n"' 2>/dev/null)
                diff_stat=$(jj diff -r "trunk()..($target)" --stat 2>/dev/null)

                # Look for a PR template in the repo.
                pr_template=""
                repo_root=$(jj workspace root 2>/dev/null || git rev-parse --show-toplevel 2>/dev/null || true)
                if [ -n "$repo_root" ]; then
                    for tmpl_path in \
                        ".github/pull_request_template.md" \
                        ".github/PULL_REQUEST_TEMPLATE.md" \
                        "PULL_REQUEST_TEMPLATE.md" \
                        "pull_request_template.md" \
                        "docs/pull_request_template.md"; do
                        if [ -f "$repo_root/$tmpl_path" ]; then
                            pr_template=$(cat "$repo_root/$tmpl_path")
                            break
                        fi
                    done
                    # Also check the directory form (use the first .md found).
                    if [ -z "$pr_template" ]; then
                        for tmpl_dir in \
                            ".github/PULL_REQUEST_TEMPLATE" \
                            ".github/pull_request_template"; do
                            if [ -d "$repo_root/$tmpl_dir" ]; then
                                first_tmpl=$(find "$repo_root/$tmpl_dir" -name '*.md' -type f | head -1)
                                if [ -n "$first_tmpl" ]; then
                                    pr_template=$(cat "$first_tmpl")
                                    break
                                fi
                            fi
                        done
                    fi
                fi

                template_section=""
                if [ -n "$pr_template" ]; then
                    template_section="
The repository has a PR template. Follow its structure for the description:
$pr_template

Template filling rules:
- Fill every section as best you can from the commits and diff stat.
- For sections or checkboxes that are not relevant to this PR, put N/A.
- For things you are unsure about or lack information for (e.g. ticket numbers, links), put TODO.
- Keep the description well-formatted, clear, and concise.
"
                fi

                # Fetch recent merged PR titles as style examples.
                pr_examples=""
                if recent_prs=$(gh pr list --state merged --limit 10 \
                        --json title --jq '.[].title' 2>/dev/null); then
                    if [ -n "$recent_prs" ]; then
                        pr_examples="
Here are recent PR titles from this repo — match their style and conventions:
$recent_prs
"
                    fi
                fi

                prompt="You are writing a GitHub pull request title and description.

Below are the commit descriptions and a diff stat for this PR.

Commit descriptions:
$descriptions

Diff stat:
$diff_stat
${template_section}${pr_examples}
Write a concise PR title (one line, no prefix like 'PR:') and a PR description in markdown.
The description should summarize what changed and why, based on the commit messages.
Keep it concise — no filler, no restating the title in the body.
If a PR template was provided, follow its structure instead of freeform markdown.
If example PR titles were provided, match their style and conventions.
Output the title on the first line, then a blank line, then the description."

                echo "Generating PR title and description..."
                if pr_text=$(pi -p --no-session --no-tools "$prompt" 2>/dev/null); then
                    pr_title=$(printf '%s\n' "$pr_text" | head -1)
                    pr_body=$(printf '%s\n' "$pr_text" | tail -n +3)

                    echo ""
                    printf '%s\n' "$pr_text"
                    echo ""

                    if pr_url=$(gh pr create --draft --title "$pr_title" \
                            --body "$pr_body" --head "$branch" 2>&1); then
                        echo "Draft PR created: $pr_url"
                        open_url "$pr_url"
                    else
                        echo "Failed to create draft PR: $pr_url"
                        echo "Opening PR creation page instead."
                        open_url "$url"
                    fi
                else
                    echo "AI generation failed, opening PR creation page."
                    open_url "$url"
                fi
            else
                open_url "$url"
            fi
            ;;
    esac
fi

exit $rc
