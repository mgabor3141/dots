// Niri configuration for CachyOS
// For documentation and full reference, see: https://github.com/YaLTeR/niri/wiki

// ────────────── Input Configuration ──────────────
// https://github.com/YaLTeR/niri/wiki/Configuration:-Input

input {
    keyboard {
        xkb {
            // layout "us"
            file "~/.config/xkb/keymap.xkb"
        }
        numlock // Enable numlock on startup
    }

    touchpad {
        tap // Enable tap-to-click
        natural-scroll // Enable natural (macOS-style) scrolling
    }

    disable-power-key-handling
    focus-follows-mouse max-scroll-amount="0%" // Automatically focus windows under the mouse pointer
}

gestures {
    dnd-edge-view-scroll {
        trigger-width 150
        delay-ms 100
        max-speed 1500
    }

    dnd-edge-workspace-switch {
        trigger-height 100
        delay-ms 100
        max-speed 1500
    }

    hot-corners {
        bottom-left
        bottom-right
    }
}

// ────────────── Output Configuration ──────────────
// You can run `niri msg outputs` to get the correct name for your displays.
// You will have to remove "/-" and edit it before it takes effect.
// https://github.com/YaLTeR/niri/wiki/Configuration:-Outputs

output "GIGA-BYTE TECHNOLOGY CO., LTD. Gigabyte M32U 21271B001538" {
    mode "3840x2160@143.999"
    scale 1.7
    variable-refresh-rate
    focus-at-startup
}

output "Dell Inc. DELL S2721D JRNFP43" {
    position x=-2194 y=0
    mode "2560x1440@74.971"
    variable-refresh-rate
    scale 1.25

    layout {
        always-center-single-column true
    }
}

// Named workspaces — declared statically, always present.
// Empty ones are skipped during up/down navigation (see skip-empty-workspace.sh).
workspace "A" {
    open-on-output "GIGA-BYTE TECHNOLOGY CO., LTD. Gigabyte M32U 21271B001538"
}
workspace "Q" {
    open-on-output "GIGA-BYTE TECHNOLOGY CO., LTD. Gigabyte M32U 21271B001538"
}
workspace "W" {
    open-on-output "GIGA-BYTE TECHNOLOGY CO., LTD. Gigabyte M32U 21271B001538"
}
workspace "T" {
    open-on-output "Dell Inc. DELL S2721D JRNFP43"
}
workspace "1e" {
    open-on-output "GIGA-BYTE TECHNOLOGY CO., LTD. Gigabyte M32U 21271B001538"
}
workspace "2e" {
    open-on-output "GIGA-BYTE TECHNOLOGY CO., LTD. Gigabyte M32U 21271B001538"
}
workspace "3e" {
    open-on-output "GIGA-BYTE TECHNOLOGY CO., LTD. Gigabyte M32U 21271B001538"
}
workspace "4e" {
    open-on-output "GIGA-BYTE TECHNOLOGY CO., LTD. Gigabyte M32U 21271B001538"
}
workspace "5e" {
    open-on-output "GIGA-BYTE TECHNOLOGY CO., LTD. Gigabyte M32U 21271B001538"
}

// ────────────── Keybindings ──────────────
// https://github.com/YaLTeR/niri/wiki/Configuration:-Key-Bindings

binds {
    // ─── Applications ───
    Mod+G                              hotkey-overlay-title="Open Launcher" { spawn-sh "qs -c noctalia-shell ipc call launcher toggle"; }
    Mod+SPACE                          hotkey-overlay-title="Open Launcher" { spawn-sh "qs -c noctalia-shell ipc call launcher toggle"; }

    // ─── Audio Controls ───
    // Example volume keys mappings for PipeWire & WirePlumber.
    // The allow-when-locked=true property makes them work even when the session is locked.
    // XF86AudioRaiseVolume               allow-when-locked=true { spawn-sh "pactl set-volume @DEFAULT_AUDIO_SINK@ 0.1+"; }
    // XF86AudioLowerVolume               allow-when-locked=true { spawn-sh "pactl set-volume @DEFAULT_AUDIO_SINK@ 0.1-"; }
    XF86AudioMute                      allow-when-locked=true { spawn-sh "pactl set-sink-mute @DEFAULT_SINK@ toggle"; }
    XF86AudioMicMute                   allow-when-locked=true { spawn-sh "pactl set-source-mute @DEFAULT_SOURCE@ toggle"; }
    XF86AudioNext                      allow-when-locked=true { spawn-sh "playerctl next"; }
    XF86AudioPause                     allow-when-locked=true { spawn-sh "playerctl play-pause"; }
    XF86AudioPlay                      allow-when-locked=true { spawn-sh "playerctl play-pause"; }
    XF86AudioStop                      allow-when-locked=true { spawn-sh "playerctl play-pause"; }
    XF86AudioPrev                      allow-when-locked=true { spawn-sh "playerctl previous"; }

    F13                                allow-when-locked=true { spawn-sh "pactl set-source-mute @DEFAULT_SOURCE@ toggle"; }

    // ─── Brightness Controls ───
    XF86MonBrightnessUp                 allow-when-locked=true { spawn-sh "qs -c noctalia-shell ipc call brightness increase"; }
    XF86MonBrightnessDown               allow-when-locked=true { spawn-sh "qs -c noctalia-shell ipc call brightness decrease"; }

    // ─── Window Movement and Focus ───
    Mod+X                             repeat=false { close-window; }

    Mod+LEFT                           { focus-column-left; }
    Mod+RIGHT                          { focus-column-right; }
    Mod+Alt+LEFT                       { focus-monitor-left; }
    Mod+Alt+RIGHT                      { focus-monitor-right; }
    Mod+S                              { focus-column-left; }
    Mod+F                              { focus-column-right; }
    Mod+Alt+S                          { focus-monitor-left; }
    Mod+Alt+F                          { focus-monitor-right; }

    Mod+Shift+LEFT                     { move-column-left; }
    Mod+Shift+RIGHT                    { move-column-right; }
    Mod+Alt+Shift+LEFT                 { move-column-to-monitor-left; }
    Mod+Alt+Shift+RIGHT                { move-column-to-monitor-right; }
    Mod+Shift+S                        { move-column-left; }
    Mod+Shift+F                        { move-column-right; }
    Mod+Alt+Shift+S                    { move-column-to-monitor-left; }
    Mod+Alt+Shift+F                    { move-column-to-monitor-right; }

    Mod+UP                             { focus-window-or-workspace-up; }
    Mod+DOWN                           { focus-window-or-workspace-down; }
    Mod+Shift+E                        { move-column-to-workspace-up; }
    Mod+Shift+D                        { move-column-to-workspace-down; }
    Mod+E                              { spawn-sh "~/.config/wm-scripts/skip-empty-workspace.sh up"; }
    Mod+D                              { spawn-sh "~/.config/wm-scripts/skip-empty-workspace.sh down"; }

    Mod+HOME                           { focus-column-first; }
    Mod+END                            { focus-column-last; }
    Mod+Shift+HOME                     { move-column-to-first; }
    Mod+Shift+END                      { move-column-to-last; }

    Mod+PAGE_UP                        { focus-monitor-left; }
    Mod+PAGE_DOWN                      { focus-monitor-right; }

    Mod+CTRL+PAGE_UP                   { move-column-to-monitor-left; }
    Mod+CTRL+PAGE_DOWN                 { move-column-to-monitor-right; }

    // ─── Workspace Switching ───
    Mod+WHEELSCROLLUP                  { focus-window-up-or-column-left; }
    Mod+WHEELSCROLLDOWN                { focus-window-down-or-column-right; }
    Mod+Shift+WHEELSCROLLUP            { move-column-left; }
    Mod+Shift+WHEELSCROLLDOWN          { move-column-right; }


    // Named workspaces — focus
    Mod+A                              { focus-workspace "A"; }
    Mod+Q                              { focus-workspace "Q"; }
    Mod+W                              { focus-workspace "W"; }
    Mod+T                              { focus-workspace "T"; }
    Mod+1                              { focus-workspace "1e"; }
    Mod+2                              { focus-workspace "2e"; }
    Mod+3                              { focus-workspace "3e"; }
    Mod+4                              { focus-workspace "4e"; }
    Mod+5                              { focus-workspace "5e"; }
    // MRU numbered workspace
    Mod+R                              { spawn-sh "~/.config/wm-scripts/last-numbered-ws.sh switch"; }

    // Named workspaces — move column + update editor mapping for numbered
    Mod+Shift+A                          { move-column-to-workspace "A"; }
    Mod+Shift+Q                          { move-column-to-workspace "Q"; }
    Mod+Shift+W                          { move-column-to-workspace "W"; }
    Mod+Shift+T                          { move-column-to-workspace "T"; }
    Mod+Shift+1                          { spawn-sh "niri msg action move-column-to-workspace 1e && ~/.config/wm-scripts/update-editor-mapping.sh 1e"; }
    Mod+Shift+2                          { spawn-sh "niri msg action move-column-to-workspace 2e && ~/.config/wm-scripts/update-editor-mapping.sh 2e"; }
    Mod+Shift+3                          { spawn-sh "niri msg action move-column-to-workspace 3e && ~/.config/wm-scripts/update-editor-mapping.sh 3e"; }
    Mod+Shift+4                          { spawn-sh "niri msg action move-column-to-workspace 4e && ~/.config/wm-scripts/update-editor-mapping.sh 4e"; }
    Mod+Shift+5                          { spawn-sh "niri msg action move-column-to-workspace 5e && ~/.config/wm-scripts/update-editor-mapping.sh 5e"; }
    // MRU numbered workspace — move
    Mod+Shift+R                          { spawn-sh "~/.config/wm-scripts/last-numbered-ws.sh move"; }

    Mod+F20                            { spawn-sh "niri msg action close-overview && niri msg action focus-workspace-previous"; }

    // ─── Layout Controls ───
    // Mod+CTRL+F                          { expand-column-to-available-width; }
    // Mod+C                               { center-column; }
    // Mod+CTRL+C                          { center-visible-columns; }
    // Mod+MINUS                           { set-column-width "-10%"; }
    // Mod+EQUAL                           { set-column-width "+10%"; }
    // Mod+Alt+MINUS                       { set-window-height "-10%"; }
    // Mod+Alt+EQUAL                       { set-window-height "+10%"; }
    Mod+C                               { switch-preset-column-width-back; }
    Mod+Shift+C                         { expand-column-to-available-width; }
    Mod+V                               { switch-preset-column-width; }
    Mod+Shift+V                         { fullscreen-window; }

    // ─── Modes ───
    Mod+Z                              { toggle-window-floating; }
    Mod+B                              { toggle-column-tabbed-display; }
    Mod+Escape                         repeat=false { toggle-overview; }

    // ─── Screenshots ───
    CTRL+SHIFT+5                       { screenshot; }
    CTRL+SHIFT+2                       { screenshot-screen; }
    CTRL+SHIFT+3                       { screenshot-window; }

    // ─── Emergency Escape Key ───
    // Use this when a fullscreen app blocks your keybinds.
    // It disables any active keyboard shortcut inhibitor, restoring control.
    Mod+Ctrl+ESCAPE                    allow-inhibiting=false { toggle-keyboard-shortcuts-inhibit; }

    // ─── Exit / Power ───
    CTRL+ALT+DELETE                    { quit; } // Also quits Niri
}

// ────────────── Startup Applications ──────────────
// https://github.com/YaLTeR/niri/wiki/Configuration:-Miscellaneous#spawn-sh-at-startup

    // noctalia-shell is now managed by systemd (auto-restarts on crash)
    // See: ~/.config/systemd/user/noctalia-shell.service

    spawn-sh-at-startup "/usr/lib/polkit-gnome/polkit-gnome-authentication-agent-1 &" // Polkit

    // Mute indicator
    spawn-sh-at-startup "pactl subscribe | ~/.config/waybar-mute-indicator/handle-mute-events.sh"

    // WM event daemon — assigns Zed windows to numbered workspaces based on project name
    spawn-sh-at-startup "~/.config/niri/event-daemon.sh"

    spawn-at-startup    "playerctld" "daemon"
    spawn-at-startup    "bing-wallpaper.sh"
    spawn-at-startup    "swayidle" "-w" \
        "timeout" "290" "notify-send --urgency=low --expire-time=10000 \"Screen is powering off soon...\"" \
        "timeout" "302" "niri msg action power-off-monitors" \
        "idlehint" "310"
        // Signal IdleHint to systemd, it can take over from there and account for cloudgaming
        // See: /etc/systemd/logind.conf

    prefer-no-csd // Disable program decorations
    screenshot-path null // Disable screenshot saving

// ────────────── Layout Settings ──────────────
// https://github.com/YaLTeR/niri/wiki/Configuration:-Layout

    layout {
        // always-center-single-column

        gaps 16 // Gap between windows
        center-focused-column "never" // Don’t auto-center focused column

        preset-column-widths {
            proportion 0.33333
            proportion 0.5
            proportion 0.66667
            proportion 1.0
        }

        default-column-width {}

        focus-ring {
            width 2
            active-color "#00ac89"
            inactive-color "#505050"
        }

        shadow {
            softness 30
            spread 5
            offset x=0 y=5
            color "#0007"
        }

        struts {
            top 0
            bottom 16
            left 16
            right 16
        }
    }

    include "../../.cache/bing-wallpaper/colors-niri.kdl"

// ────────────── Animation Settings ──────────────
// https://github.com/YaLTeR/niri/wiki/Configuration:-Animations
    animations {
        slowdown 0.5
        workspace-switch {
            spring damping-ratio=1.0 stiffness=1000 epsilon=0.0001
        }
        window-open {
            duration-ms 200
            curve "ease-out-quad"
        }
        window-close {
            duration-ms 200
            curve "ease-out-cubic"
        }
        horizontal-view-movement {
            spring damping-ratio=1.0 stiffness=900 epsilon=0.0001
        }
        window-movement {
            spring damping-ratio=1.0 stiffness=800 epsilon=0.0001
        }
        window-resize {
            spring damping-ratio=1.0 stiffness=1000 epsilon=0.0001
        }
        config-notification-open-close {
            spring damping-ratio=0.6 stiffness=1200 epsilon=0.001
        }
        screenshot-ui-open {
            duration-ms 300
            curve "ease-out-quad"
        }
        overview-open-close {
            spring damping-ratio=1.0 stiffness=900 epsilon=0.0001
        }
    }

// ────────────── Window Rules ──────────────
// https://github.com/YaLTeR/niri/wiki/Configuration:-Window-Rules

    // Example: block out windows from screen capture.
    window-rule {
        match app-id="zen" title=r#"^Extension:"#
        match app-id="zen" title=r#"(Gmail|Home Assistant|Zoho Mail .*|Messenger)\s— Zen Browser$"#
        match app-id="zen" title=r#"^Google Calendar - .* — Zen Browser$"#
        match app-id="dev.zed.Zed" title=r#"\.env$"#
        match app-id="Bitwarden"
        match app-id="org.kde.dolphin"
        match app-id="org.gnome.Nautilus"
        match app-id="xdg-desktop-portal-gtk"
        match app-id="discord"
        match app-id="vesktop"
        match app-id="qt-sudo"
        match app-id="polkit-gnome-authentication-agent-1"

        block-out-from "screen-capture"

        // Use this instead if you want them visible on third-party screenshot tools.
        // block-out-from "screencast"
    }

    // Block out notifications from screencasts
    layer-rule {
        match namespace="notifications"
        block-out-from "screencast"
    }

    window-rule {
        geometry-corner-radius 8
        clip-to-geometry true
    }

    // Set the overview wallpaper on the backdrop
    layer-rule {
        match namespace="^noctalia-overview"
        place-within-backdrop true
    }

    // Indicate screencasted windows with red colors.
    window-rule {
        match is-window-cast-target=true

        focus-ring {
            active-color "#f38ba8"
            inactive-color "#7d0d2d"
        }

        border {
            inactive-color "#7d0d2d"
        }

        shadow {
            color "#7d0d2d70"
        }

        tab-indicator {
            active-color "#f38ba8"
            inactive-color "#7d0d2d"
        }
    }

    hotkey-overlay {
        skip-at-startup
    }

    debug {
        // preview-render "screencast"
        honor-xdg-activation-with-invalid-serial
    }

    window-rule {
        match is-floating=true
        focus-ring {
            width 1
        }
    }

// Custom window workspaces and positions

    window-rule {
        match app-id="zen" at-startup=true
        open-on-workspace "A"
        default-column-width {
            proportion 0.75
        }
    }

    window-rule {
        match app-id=r#"(firefox|zen)$"# title="^Picture-in-Picture$"
        open-on-output "Dell Inc. DELL S2721D JRNFP43"
        open-focused false
        open-floating true
        default-floating-position x=4 y=4 relative-to="top-right"
        default-column-width {
            proportion 0.5
        }
    }

    // Zed editor windows are dynamically assigned to numbered workspaces
    // by the event daemon (event-daemon.sh → assign-editor-workspace.sh)

    window-rule {
        match app-id="steam"
        exclude title=r#"^notificationtoasts_\d+_desktop$"#
        open-on-workspace "5e"
        open-focused true
    }

    window-rule {
        match app-id="steam" title=r#"^notificationtoasts_\d+_desktop$"#
        default-floating-position x=10 y=10 relative-to="bottom-right"
        open-floating true
        open-focused false
    }

    window-rule {
        match app-id="spotify"
        open-on-workspace "T"
        open-focused true
        default-column-width {
            fixed 800
        }
    }

    window-rule {
        match app-id="vesktop"
        match app-id="discord"
        open-on-workspace "T"
        open-focused true
        default-column-width {
            proportion 1.0
        }
    }

    window-rule {
        match app-id="qt-sudo"
        open-floating true
    }
