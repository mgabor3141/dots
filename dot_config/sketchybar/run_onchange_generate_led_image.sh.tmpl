#!/bin/bash
# Generate the mic-mute LED glow indicator image.
#
# Three composited layers (outer glow → mid glow → bright core) with gaussian
# blur produce a glowing LED strip effect.
#
# This is a run_onchange_ script: it only re-runs when the script content
# changes (chezmoi tracks the hash). We can't use modify_ because ImageMagick's
# blur produces non-deterministic output across process invocations (ASLR
# affects floating-point rounding), causing chezmoi diff to always show changes.
#
# Requires: ImageMagick 7 (magick)
#
# Color reference: matches the waybar mute indicator CSS gradient
#   (dot_config/waybar-mute-indicator/style.css)

set -euo pipefail

target="{{ joinPath (.chezmoi.targetFile | dir) "images" }}"
mkdir -p "$target"

magick -size 500x30 xc:none \
  \( -size 500x30 xc:none \
     -fill "rgba(255,0,0,0.7)" -draw "roundrectangle 50,7 449,22 8,8" \
     -blur 12x9 \
  \) -gravity center -composite \
  \( -size 500x30 xc:none \
     -fill "rgba(255,40,40,1)" -draw "roundrectangle 53,10 446,19 5,5" \
     -blur 8x4 \
  \) -gravity center -composite \
  \( -size 500x30 xc:none \
     -fill "rgba(255,200,200,0.95)" -draw "roundrectangle 55,12 444,17 3,3" \
     -blur 6x1 \
  \) -gravity center -composite \
  "$target/mic_mute_led.png"
