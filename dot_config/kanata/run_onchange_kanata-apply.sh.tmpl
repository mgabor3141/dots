#!/bin/bash
trap 'echo "âŒ Error on line $LINENO: $BASH_COMMAND" >&2' ERR
set -Eeuo pipefail

# This script will run if any of the hashed files have changed
# {{ include "dot_config/kanata/shared.kbd" | sha256sum }}

# {{ include "dot_config/kanata/kanata-macbook-ansi.kbd" | sha256sum }}
kanata --check --cfg {{ .chezmoi.sourceDir }}/dot_config/kanata/kanata-macbook-ansi.kbd

# {{ include "dot_config/kanata/kanata-macos-razer.kbd" | sha256sum }}
kanata --check --cfg {{ .chezmoi.sourceDir }}/dot_config/kanata/kanata-macos-razer.kbd

send_reload() {
  local port="$1"
  printf '{"Reload":{}}\n' |
    nc -w 1 127.0.0.1 "$port" |
    awk '
      /"status":"Ok"/ { exit 0 }
      { print }
    '
}

send_reload 53141
send_reload 53142

echo "Kanata configuration applied"
