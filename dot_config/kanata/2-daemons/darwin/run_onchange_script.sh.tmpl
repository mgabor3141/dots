#!/bin/bash
trap 'echo "âŒ Error on line $LINENO: $BASH_COMMAND" >&2' ERR
set -Eeuo pipefail

install_service() {
  local name="$1"
  local src="{{ .chezmoi.destDir }}/.config/kanata/2-daemons/darwin/$name.plist"
  local dst="/Library/LaunchDaemons/$name.plist"

  echo "Installing $name..."

  sudo cp -rf "$src" "$dst"
  sudo launchctl bootout system "$dst" || true
  sudo launchctl bootstrap system "$dst"
  sudo launchctl enable "system/$name"
}

wait_for_service() {
    local svc="$1"

    until sudo launchctl print "system/$svc" 2>/dev/null | grep -q "pid ="; do
        sleep 1
    done
}

# {{ joinPath .chezmoi.sourceDir (.chezmoi.sourceFile | dir) "io.github.jtroo.kanata.macbook-ansi.plist.tmpl" | include | sha256sum }}
install_service io.github.jtroo.kanata.macbook-ansi

# {{ joinPath .chezmoi.sourceDir (.chezmoi.sourceFile | dir) "io.github.jtroo.kanata.macos-razer.plist.tmpl" | include | sha256sum }}
install_service io.github.jtroo.kanata.macos-razer

echo "Waiting for services to come online..."
wait_for_service io.github.jtroo.kanata.macbook-ansi
wait_for_service io.github.jtroo.kanata.macos-razer

# wait for kanata launch delay
sleep 2

echo "Done setting up kanata services"
echo "Don't forget to remove stale services if the names change"
