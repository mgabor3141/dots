#!/bin/bash
trap 'echo "âŒ Error on line $LINENO: $BASH_COMMAND" >&2' ERR
set -Eeuo pipefail

install_service() {
  local name="$1"
  local src="{{ .chezmoi.destDir }}/.config/kanata/2-daemons/darwin/$name.plist"
  local dst="/Library/LaunchDaemons/$name.plist"

  echo "Installing $name..."

  sudo rm /tmp/$name || true
  sudo cp -rf "$src" "$dst"
  sudo launchctl bootstrap system "$dst"
  sudo launchctl enable "system/$name"
}

wait_for_service() {
    local svc="$1"

    until sudo launchctl print "system/$svc" 2>/dev/null | grep -q "pid ="; do
        sleep 1
    done
}

# Clean up all services, even if they have been renamed
shopt -s nullglob
for plist in /Library/LaunchDaemons/io.github.jtroo.kanata.*; do
    # Only act on regular files
    if [[ -f "$plist" ]]; then
        echo "Unloading: $plist"
        sudo launchctl bootout system "$plist" || true
        sudo rm "$plist"
    fi
done

# {{ joinPath .chezmoi.sourceDir (.chezmoi.sourceFile | dir) "io.github.jtroo.kanata.macbook-ansi.plist.tmpl" | include | sha256sum }}
install_service io.github.jtroo.kanata.macbook-ansi

# {{ joinPath .chezmoi.sourceDir (.chezmoi.sourceFile | dir) "io.github.jtroo.kanata.macos-razer.plist.tmpl" | include | sha256sum }}
install_service io.github.jtroo.kanata.macos-razer

# {{ joinPath .chezmoi.sourceDir (.chezmoi.sourceFile | dir) "io.github.jtroo.kanata.go60.plist.tmpl" | include | sha256sum }}
install_service io.github.jtroo.kanata.go60

echo "Waiting for services to come online..."
wait_for_service io.github.jtroo.kanata.macbook-ansi
wait_for_service io.github.jtroo.kanata.macos-razer
wait_for_service io.github.jtroo.kanata.go60

# wait for kanata launch delay
sleep 3

echo -e "\t>>> Logs for macbook-ansi:"
cat /tmp/io.github.jtroo.kanata.macbook-ansi
echo -e "\t>>> Logs for macos-razer:"
cat /tmp/io.github.jtroo.kanata.macos-razer
echo -e "\t>>> Logs for go60:"
cat /tmp/io.github.jtroo.kanata.go60

echo "Done setting up kanata services"
