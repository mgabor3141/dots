#!/bin/sh
set -eu

KANATA="/opt/homebrew/bin/kanata"
CONFIG_DIR="{{ .chezmoi.destDir }}/.config/kanata/1-configs"

YELLOW='\033[0;33m'
GREEN='\033[0;32m'
CYAN='\033[0;36m'
RESET='\033[0m'
config_color() {
    case "$1" in
        macbook-ansi.kbd) echo "$YELLOW" ;;
        razer.kbd) echo "$GREEN" ;;
        go60.kbd) echo "$CYAN" ;;
        *) echo "$RESET" ;;
    esac
}

log() { echo "[$(date '+%Y-%m-%d %H:%M:%S')] $*"; }

log "Starting kanata-manager"
pkill -x kanata 2>/dev/null || true

for cfg in macbook-ansi.kbd razer.kbd go60.kbd; do
    color=$(config_color "$cfg")
    log "Starting $cfg"
    "$KANATA" --cfg "${CONFIG_DIR}/${cfg}" 2>&1 \
        | while IFS= read -r line; do
            echo "${color}[${cfg}]${RESET} $line"
          done &
done

wait
log "A kanata process exited"
