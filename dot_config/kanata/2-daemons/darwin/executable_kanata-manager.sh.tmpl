#!/bin/sh
set -eu

KANATA_BIN="/opt/homebrew/bin/kanata"
CONFIG_DIR="{{ .chezmoi.destDir }}/.config/kanata/1-configs"

CONFIGS="macbook-ansi.kbd razer.kbd go60.kbd"

YELLOW='\033[0;33m'
GREEN='\033[0;32m'
CYAN='\033[0;36m'
RESET='\033[0m'
config_color() {
    case "$1" in
        macbook-ansi.kbd) echo "$YELLOW" ;;
        razer.kbd) echo "$GREEN" ;;
        go60.kbd) echo "$CYAN" ;;
        *) echo "$RESET" ;;
    esac
}

log() { echo "[$(date '+%Y-%m-%d %H:%M:%S')] $*"; }

log "Starting kanata-manager"
pkill kanata 2>/dev/null || true
sleep 1

PIDS=""

for cfg in $CONFIGS; do
    cfg_path="${CONFIG_DIR}/${cfg}"
    color=$(config_color "$cfg")

    log "Starting $cfg"
    "$KANATA_BIN" --cfg "$cfg_path" 2>&1 | while IFS= read -r line; do
        echo "${color}[$cfg]${RESET} $line"
    done &
    PIDS="$PIDS $!"
done

log "All configs started. PIDs:$PIDS"

# Wait for any child to exit
wait
log "A kanata process exited unexpectedly. Cleaning up..."
kill $PIDS 2>/dev/null || true
