#!/bin/sh
set -eu

KANATA="/opt/homebrew/bin/kanata"
CONFIG_DIR="{{ .chezmoi.destDir }}/.config/kanata/1-configs"
POLL_INTERVAL=3

log() { echo "[$(date '+%Y-%m-%d %H:%M:%S')] $*"; }

# Map config filenames to the device name used in macos-dev-names-include.
# hidutil list is used to check if the device is connected.
device_name() {
    case "$1" in
        macbook-ansi.kbd) echo "Apple Internal Keyboard / Trackpad" ;;
        razer.kbd) echo "Razer BlackWidow Ultimate" ;;
        go60.kbd) echo "Go60" ;;
    esac
}

device_connected() {
    hidutil list --matching '{}' 2>/dev/null | grep -qF "$1"
}

# Track running kanata instances: cfg -> PID
# POSIX sh doesn't have associative arrays, so use files in a temp dir.
STATE_DIR=$(mktemp -d)
trap 'rm -rf "$STATE_DIR"' EXIT

pid_file()  { echo "$STATE_DIR/$1.pid"; }
is_running() {
    pf=$(pid_file "$1")
    [ -f "$pf" ] && kill -0 "$(cat "$pf")" 2>/dev/null
}

start_kanata() {
    cfg="$1"
    log "Starting $cfg"
    # Start kanata directly â€” do NOT pipe through a subshell, because $! would
    # capture the subshell PID instead of kanata's, and stop_kanata would then
    # orphan the real kanata process (which keeps an exclusive keyboard grab).
    "$KANATA" --cfg "${CONFIG_DIR}/${cfg}" \
        >"/tmp/io.github.jtroo.kanata.${cfg%.kbd}.log" 2>&1 &
    echo "$!" > "$(pid_file "$cfg")"
    log "Started $cfg (pid $!)"
}

stop_kanata() {
    cfg="$1"
    pf=$(pid_file "$cfg")
    [ -f "$pf" ] || return 0
    pid=$(cat "$pf")
    log "Stopping $cfg (pid $pid)"
    kill "$pid" 2>/dev/null || true
    rm -f "$pf"
}

# --- Main ---
log "Starting kanata-manager"
pkill -x kanata 2>/dev/null || true

CONFIGS="macbook-ansi.kbd razer.kbd go60.kbd"

while true; do
    for cfg in $CONFIGS; do
        dev=$(device_name "$cfg")
        connected=$(device_connected "$dev" && echo 1 || echo 0)
        running=$(is_running "$cfg" && echo 1 || echo 0)

        if [ "$connected" = "1" ] && [ "$running" = "0" ]; then
            start_kanata "$cfg"
        elif [ "$connected" = "0" ] && [ "$running" = "1" ]; then
            stop_kanata "$cfg"
        fi
    done

    sleep "$POLL_INTERVAL"
done
