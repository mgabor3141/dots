#!/bin/bash
# Generate the mic-mute LED glow indicator image.
#
# Three composited layers (outer glow → mid glow → bright core) with gaussian
# blur produce a glowing LED strip effect.
#
# This is a run_onchange_ script: it only re-runs when the script content
# changes (chezmoi tracks the hash). We can't use modify_ because ImageMagick's
# blur produces non-deterministic output across process invocations (ASLR
# affects floating-point rounding), causing chezmoi diff to always show changes.
#
# Requires: ImageMagick 7 (magick)
#
# Used by:
#   - sketchybar (macOS): dot_config/sketchybar/items/executable_mic.sh
#   - waybar-mute-indicator (Linux): dot_config/waybar-mute-indicator/

set -euo pipefail

# --- Tunables ---
W=500   # image width  (should match item width in sketchybar/items/mic.sh and waybar-mute-indicator/config)
H=30    # image height

# Derived coordinates — LED strip runs from 10% to 90% of width, centered vertically.
margin=$((W / 10))

# Outer glow
ox1=$margin                 ox2=$((W - margin - 1))
oy1=$((H * 7 / 30))        oy2=$((H * 22 / 30))

# Mid glow (inset 3px from outer)
mx1=$((margin + 3))         mx2=$((W - margin - 4))
my1=$((H / 3))              my2=$((H * 19 / 30))

# Bright core (inset 5px from outer)
cx1=$((margin + 5))         cx2=$((W - margin - 6))
cy1=$((H * 2 / 5))          cy2=$((H * 17 / 30))

target="{{ .chezmoi.targetFile | dir }}"

magick -size "${W}x${H}" xc:none \
  \( -size "${W}x${H}" xc:none \
     -fill "rgba(255,0,0,0.7)" -draw "roundrectangle $ox1,$oy1 $ox2,$oy2 8,8" \
     -blur 12x9 \
  \) -gravity center -composite \
  \( -size "${W}x${H}" xc:none \
     -fill "rgba(255,40,40,1)" -draw "roundrectangle $mx1,$my1 $mx2,$my2 5,5" \
     -blur 8x4 \
  \) -gravity center -composite \
  \( -size "${W}x${H}" xc:none \
     -fill "rgba(255,200,200,0.95)" -draw "roundrectangle $cx1,$cy1 $cx2,$cy2 3,3" \
     -blur 6x1 \
  \) -gravity center -composite \
  "$target/mic_mute_led.png"
